class_name Player
extends CharacterBody2D

@export var speed: float = 300.0
@export var jump_velocity: float = -400.0
@export var gravity: int = ProjectSettings.get_setting("physics/2d/default_gravity") #Standartmäßig: 980
@export var start_fall_dmg: int = 800
@export var end_fall_dmg: int = 2400
@export var damage_reduction: float = 0.0
@export var start_live: float = 100.0
@export var start_attempts: int = 5

var can_jump: bool = true
var can_double_jump: bool = true
var current_fall_dmg: float = 0
var walljump: bool = false
var hold: int = 0 #For Reset
var can_move = true
var live = start_live
var attempts = start_attempts

var jump_boost: float = 1.0
var velocity_boost: float = 1.0
var max_fall_speed: float = 100
var limit_fall_speed: bool = false

func _physics_process(delta):
	if not is_on_floor():
		if (velocity.y) < max_fall_speed and limit_fall_speed:
			velocity.y += gravity * delta
		elif not limit_fall_speed:
			velocity.y += gravity * delta

		if velocity.y > start_fall_dmg:
			current_fall_dmg = (velocity.y - start_fall_dmg) / (end_fall_dmg - start_fall_dmg)
	else:
		walljump = false
		if current_fall_dmg > 0:
			get_damage("Fall_Damage", current_fall_dmg * 100)
	
	if can_move:
		
		if Input.is_action_pressed("Reset"):
			hold += 1
			if hold >= 120:
				get_parent().ded("Reset")
				hold = 0
		else:
			hold = 0
	
		if Input.is_action_pressed("Jump"):
			if is_on_floor() and can_jump:
				velocity.y = jump_velocity
			elif is_on_wall_only() and can_double_jump and not walljump:
				velocity.y = jump_velocity
				walljump = true
		
	var direction = Input.get_axis("Move_L", "Move_R")
	if direction and can_move:
		velocity.x = direction * speed
	else:
		velocity.x = move_toward(velocity.x, 0, speed)
	
	move_and_slide()

func get_damage(reason: String, damage: float)->void:
	live -= damage
	current_fall_dmg = 0
	print(live)
	
func respawn()->void:
	current_fall_dmg = 0
	attempts -= 1
	if attempts <= 0:
		get_parent().lose()
		
	live = start_live
	velocity = Vector2(0, 0)
	print(live)
